Omega = tabla$Omega_McDonald,
Interpretacion = tabla$Interpretacion,
stringsAsFactors = FALSE
)
write_xlsx(tabla_descarga, file)
}
)
# ========== DESCRIPTIVOS ==========
output$selector_vars_descriptivos <- renderUI({
req(resultados$vars_numericas)
checkboxGroupInput(
"vars_descriptivos_sel",
"Selecciona variables:",
choices = resultados$vars_numericas,
selected = NULL
)
})
observeEvent(input$btn_calcular_descriptivos, {
req(datos_reactive(), input$vars_descriptivos_sel)
if (length(input$vars_descriptivos_sel) == 0) {
showNotification("Selecciona al menos una variable", type = "warning")
return()
}
withProgress(message = "Calculando descriptivos...", {
resultados$descriptivos <- calcular_descriptivos(datos_reactive(), input$vars_descriptivos_sel)
})
if (!is.null(resultados$descriptivos)) {
showNotification("Descriptivos calculados", type = "message")
} else {
showNotification("No hay variables válidas para descriptivos.", type = "error")
}
})
output$tabla_descriptivos <- DT::renderDataTable({
req(resultados$descriptivos)
DT::datatable(
resultados$descriptivos,
options = list(
pageLength = 20,
scrollX = TRUE,
autoWidth = TRUE,
columnDefs = list(
list(className = 'dt-center', targets = '_all')
)
),
rownames = FALSE,
caption = "Estadísticos Descriptivos (M = Media, DE = Desviación Estándar, zg1 = Asimetría Z, zg2 = Curtosis Z)"
) %>%
DT::formatStyle(
'zg1',
backgroundColor = DT::styleInterval(c(-1.96, 1.96), c('#ffd4d4', '#e8f4f8', '#ffd4d4')),
color = DT::styleInterval(c(-1.96, 1.96), c('#721c24', '#155724', '#721c24'))
) %>%
DT::formatStyle(
'zg2',
backgroundColor = DT::styleInterval(c(-1.96, 1.96), c('#ffd4d4', '#e8f4f8', '#ffd4d4')),
color = DT::styleInterval(c(-1.96, 1.96), c('#721c24', '#155724', '#721c24'))
)
})
# Descarga para tab Descriptivos
output$descargar_descriptivos <- downloadHandler(
filename = function() paste0("Descriptivos_", Sys.Date(), ".xlsx"),
content = function(file) {
if (is.null(resultados$descriptivos) || nrow(resultados$descriptivos) == 0) {
showNotification("No hay resultados de descriptivos para descargar. Ejecuta primero el análisis de descriptivos.",
type = "error", duration = 5)
return(NULL)
}
write_xlsx(resultados$descriptivos, file)
}
)
# ========== CORRELACIONES ==========
output$selector_vars_correlaciones <- renderUI({
req(resultados$vars_numericas)
checkboxGroupInput(
"vars_correlaciones_sel",
"Selecciona variables (mínimo 2):",
choices = resultados$vars_numericas,
selected = NULL
)
})
observeEvent(input$btn_calcular_correlaciones, {
req(datos_reactive(), input$vars_correlaciones_sel)
if (length(input$vars_correlaciones_sel) < 2) {
showNotification("Selecciona al menos 2 variables", type = "warning")
return()
}
withProgress(message = "Calculando correlaciones...", {
resultados$correlaciones <- calcular_correlaciones(
datos_reactive(),
input$vars_correlaciones_sel,
input$metodo_correlacion
)
})
if (!is.null(resultados$correlaciones)) {
showNotification("Correlaciones calculadas", type = "message")
} else {
showNotification("Error: No hay suficientes datos limpios para correlacionar las variables seleccionadas (n<3).", type = "error")
}
})
output$tabla_correlaciones <- DT::renderDataTable({
req(resultados$correlaciones)
# Añadir columna de nombres de variables
tabla <- resultados$correlaciones
tabla <- cbind(Variable = rownames(tabla), tabla)
rownames(tabla) <- NULL
DT::datatable(
tabla,
options = list(
pageLength = 20,
scrollX = TRUE,
autoWidth = FALSE,
columnDefs = list(
list(width = '150px', targets = 0),  # Primera columna más ancha
list(className = 'dt-center', targets = 1:ncol(tabla)-1)
)
),
escape = FALSE, # Para que los asteriscos se muestren correctamente
caption = "Matriz de Correlaciones (Spearman o Pearson). *** p<.001, ** p<.01, * p<.05, NC = No Calculable"
) %>%
DT::formatStyle(
columns = 1:ncol(tabla),
backgroundColor = DT::styleEqual(c(''), c('transparent'))
)
})
output$plot_correlaciones <- renderPlot({
req(datos_reactive(), input$vars_correlaciones_sel)
# Obtener datos seleccionados
df_transformed <- datos_reactive() %>%
select(all_of(input$vars_correlaciones_sel)) %>%
na.omit()
# Calcular matriz de correlaciones
M <- cor(df_transformed)
# Crear corrplot sencillo y profesional
corrplot(M,
method = "circle",
type = "lower",
tl.col = "black",
tl.srt = 45,
number.cex = 0.75,
addCoef.col = "black")
})
# Descarga para tab Correlaciones
output$descargar_correlaciones <- downloadHandler(
filename = function() paste0("Correlaciones_", Sys.Date(), ".xlsx"),
content = function(file) {
if (is.null(resultados$correlaciones) || nrow(resultados$correlaciones) == 0) {
showNotification("No hay resultados de correlaciones para descargar. Ejecuta primero el análisis de correlaciones.",
type = "error", duration = 5)
return(NULL)
}
tabla <- resultados$correlaciones
tabla <- cbind(Variable = rownames(tabla), tabla)
rownames(tabla) <- NULL
write_xlsx(tabla, file)
}
)
# Descarga para corrplot en JPG (Alta resolución)
output$descargar_corrplot_jpg <- downloadHandler(
filename = function() paste0("Corrplot_", Sys.Date(), ".jpg"),
content = function(file) {
req(input$vars_correlaciones_sel)
# Obtener datos seleccionados
df_transformed <- datos_reactive() %>%
select(all_of(input$vars_correlaciones_sel)) %>%
na.omit()
if (nrow(df_transformed) == 0) {
showNotification("No hay datos válidos para generar el corrplot.",
type = "error", duration = 5)
return(NULL)
}
# Calcular matriz de correlaciones
M <- cor(df_transformed)
# Guardar en JPG de alta resolución
jpeg(file, width = 2400, height = 2400, res = 300, quality = 95)
# Crear corrplot
corrplot(M,
method = "circle",
type = "lower",
tl.col = "black",
tl.srt = 45,
number.cex = 0.75,
addCoef.col = "black")
dev.off()
}
)
# ========== COMPARACIONES (CÓDIGO CORREGIDO) ==========
output$selector_vars_comparacion <- renderUI({
req(resultados$vars_numericas)
checkboxGroupInput(
"vars_comparacion_sel",
"Variables dependientes (Numéricas):",
choices = resultados$vars_numericas,
selected = NULL
)
})
observeEvent(input$btn_comparar_grupos, {
req(datos_reactive(), input$var_grupo, input$vars_comparacion_sel, input$metodo_comparacion)
if (input$var_grupo == "" || length(input$vars_comparacion_sel) == 0) {
showNotification("Selecciona variable de agrupación y al menos una variable dependiente.", type = "warning")
return()
}
datos <- datos_reactive()
datos[[input$var_grupo]] <- factor(datos[[input$var_grupo]]) # Asegurar que es factor
grupos <- levels(datos[[input$var_grupo]][!is.na(datos[[input$var_grupo]])])
num_grupos <- length(grupos)
metodo <- input$metodo_comparacion
# Validación de número de grupos según el método seleccionado
if (metodo %in% c("ttest", "mannwhitney") && num_grupos != 2) {
showNotification(paste0("Error: El método '", metodo, "' requiere exactamente 2 grupos. Tu variable tiene ", num_grupos, "."), type = "error", duration = 6)
resultados$comparacion <- NULL
return()
}
if (metodo %in% c("anova", "kruskal") && num_grupos < 3) {
showNotification(paste0("Error: El método '", metodo, "' requiere 3 o más grupos. Tu variable tiene ", num_grupos, "."), type = "error", duration = 6)
resultados$comparacion <- NULL
return()
}
withProgress(message = "Comparando grupos...", {
# Se pasan los parámetros: metodo y usar_mdn_ric
comparacion_actual <- comparar_grupos(
datos_reactive(),
input$vars_comparacion_sel,
input$var_grupo,
metodo,
usar_mdn_ric = input$usar_mdn_ric
)
# Actualizar resultados$comparacion para mostrar en la tabla
resultados$comparacion <- comparacion_actual
# Agregar a la lista acumulativa de comparaciones
if (!is.null(comparacion_actual)) {
# Crear nombre descriptivo para la hoja (máximo 31 caracteres para Excel)
num_comparacion <- length(resultados$comparaciones_lista) + 1
nombre_hoja <- paste0("Comparacion_", num_comparacion)
# Agregar a la lista con información de metadatos
resultados$comparaciones_lista[[nombre_hoja]] <- list(
tabla = comparacion_actual,
metodo = metodo,
var_grupo = input$var_grupo,
vars_analizadas = input$vars_comparacion_sel,
fecha = Sys.Date()
)
}
})
if (!is.null(resultados$comparacion)) {
num_total <- length(resultados$comparaciones_lista)
showNotification(
paste0("Comparación completada (Total guardado: ", num_total, ")"),
type = "message"
)
} else {
showNotification("Error al comparar grupos. Verifica que las variables dependientes sean numéricas y el número de grupos sea adecuado.", type = "error")
}
})
output$tabla_comparacion <- DT::renderDataTable({
# Requerir los resultados y método.
req(input$var_grupo, input$metodo_comparacion, resultados$comparacion)
tabla <- resultados$comparacion
# Validar que la tabla tiene datos
if (is.null(tabla) || nrow(tabla) == 0) {
return(DT::datatable(
data.frame(Mensaje = "No hay resultados para mostrar. Asegúrate de seleccionar variables numéricas."),
options = list(dom = 't'),
rownames = FALSE
))
}
# Si la tabla contiene columna 'Nota', mostrar errores específicos
if ("Nota" %in% names(tabla)) {
return(DT::datatable(
tabla,
options = list(
dom = 'tp',
pageLength = 10,
scrollX = TRUE
),
rownames = FALSE,
caption = "Mensajes de Error en Comparaciones"
))
}
# Reformatear tabla para presentación académica
tabla_formateada <- reformatear_tabla_comparaciones(tabla, datos_reactive(), input$var_grupo)
# Si no se pudo reformatear, mostrar tabla original
if (is.null(tabla_formateada)) {
return(DT::datatable(
tabla,
options = list(
dom = 'tp',
pageLength = 10,
scrollX = TRUE
),
rownames = FALSE
))
}
# Crear DataTable con tabla formateada
dt_out <- DT::datatable(
tabla_formateada,
options = list(
pageLength = 15,
scrollX = TRUE,
dom = 'Bfrtip',
autoWidth = TRUE,
columnDefs = list(
list(className = 'dt-center', targets = '_all'),
list(className = 'dt-left', targets = 0)
)
),
rownames = FALSE,
caption = paste0("Tabla de Comparación de Grupos - ", input$metodo_comparacion, ". (P < .05: Significativo)")
)
# Aplicar colores al p-valor SI existe
if ("p" %in% names(tabla_formateada)) {
dt_out <- dt_out %>%
DT::formatStyle(
'p',
backgroundColor = DT::styleInterval(0.05, c('#f8d7da', '#d4edda')),
color = DT::styleInterval(0.05, c('#721c24', '#155724'))
)
}
return(dt_out)
})
# Selector dinámico de variables significativas para el boxplot
output$selector_variables_boxplot <- renderUI({
req(resultados$comparacion, input$var_grupo, input$vars_comparacion_sel)
# Obtener variables significativas de la tabla de comparación
vars_sig <- obtener_variables_significativas(resultados$comparacion)
if (is.null(vars_sig) || length(vars_sig) == 0) {
return(div(
class = "alert alert-info",
icon("info-circle"),
strong("No hay variables con diferencias significativas."),
"Las pruebas post-hoc solo se muestran cuando p ≤ 0.05."
))
}
# Crear selector con variables significativas
fluidRow(
column(
6,
selectInput(
inputId = "var_boxplot_seleccionada",
label = "Selecciona variable a visualizar:",
choices = vars_sig,
selected = vars_sig[1]
)
)
)
})
# Boxplot para visualización de comparaciones - VERSIÓN CORREGIDA
output$plot_boxplot_comparacion <- renderPlot({
req(resultados$comparacion, input$var_grupo, input$vars_comparacion_sel)
# Obtener variable seleccionada del selector dinámico
req(input$var_boxplot_seleccionada)
variable <- input$var_boxplot_seleccionada
if (is.null(variable) || length(variable) == 0) {
return(NULL)
}
# Verificar que la variable sea significativa
vars_sig <- obtener_variables_significativas(resultados$comparacion)
if (is.null(vars_sig) || !variable %in% vars_sig) {
return(NULL)
}
# Crear boxplot
plot <- crear_boxplot_comparaciones(
datos_reactive(),
variable,
input$var_grupo
)
return(plot)
})
# Pruebas Post-hoc (Tukey o Dunn)
output$tabla_posthoc_comparacion <- DT::renderDataTable({
req(resultados$comparacion, input$var_grupo, input$metodo_comparacion, input$vars_comparacion_sel)
tabla_actual <- resultados$comparacion
# Verificar si la prueba fue significativa
if (is.null(tabla_actual) || nrow(tabla_actual) == 0) {
return(DT::datatable(
data.frame(Mensaje = "Primero realiza una comparación de grupos"),
options = list(dom = 't'),
rownames = FALSE
))
}
# Verificar significancia
if ("p" %in% names(tabla_actual)) {
p_valores <- tabla_actual$p
todas_no_sig <- all(p_valores > 0.05, na.rm = TRUE)
if (todas_no_sig) {
return(DT::datatable(
data.frame(Mensaje = "No hay diferencias significativas (p > 0.05). Las pruebas post-hoc no son necesarias."),
options = list(dom = 't'),
rownames = FALSE
))
}
}
# Obtener variable (la primera seleccionada)
variable <- input$vars_comparacion_sel[1]
if (is.null(variable) || length(variable) == 0) {
return(NULL)
}
# Seleccionar función post-hoc según el método
posthoc_df <- NULL
if (input$metodo_comparacion == "anova") {
# Usar Games-Howell (post-hoc robusto para Welch ANOVA)
posthoc_df <- calcular_games_howell(
datos_reactive(),
variable,
input$var_grupo
)
caption_text <- "Prueba Post-hoc: Games-Howell (Welch ANOVA)"
} else if (input$metodo_comparacion == "kruskal") {
# Usar Dunn's test
posthoc_df <- calcular_dunn_test(
datos_reactive(),
variable,
input$var_grupo
)
caption_text <- "Prueba Post-hoc: Dunn's Test (Kruskal-Wallis)"
} else {
return(DT::datatable(
data.frame(Mensaje = "Las pruebas post-hoc no aplican para este método (se requieren 3+ grupos)"),
options = list(dom = 't'),
rownames = FALSE
))
}
# Mostrar tabla si se calculó
if (!is.null(posthoc_df) && nrow(posthoc_df) > 0) {
DT::datatable(
posthoc_df,
options = list(
pageLength = 10,
scrollX = TRUE,
dom = 'tp',
autoWidth = TRUE,
columnDefs = list(
list(className = 'dt-center', targets = '_all')
)
),
rownames = FALSE,
caption = caption_text
)
} else {
DT::datatable(
data.frame(Mensaje = "No se pudieron calcular las comparaciones post-hoc. Verifica que tengas 3+ grupos y datos válidos."),
options = list(dom = 't'),
rownames = FALSE
)
}
})
# Descarga para tab Comparaciones
output$descargar_comparacion <- downloadHandler(
filename = function() paste0("Comparaciones_", Sys.Date(), ".xlsx"),
content = function(file) {
# Verificar si hay comparaciones en la lista o comparación actual
if (length(resultados$comparaciones_lista) > 0) {
# Modo: Múltiples comparaciones acumuladas
tryCatch({
lista_hojas <- list()
# Crear hoja de resumen
resumen_data <- data.frame(
Número = seq_along(resultados$comparaciones_lista),
Método = sapply(resultados$comparaciones_lista, function(x) x$metodo),
Variable_Grupo = sapply(resultados$comparaciones_lista, function(x) x$var_grupo),
Fecha = sapply(resultados$comparaciones_lista, function(x) as.character(x$fecha))
)
lista_hojas[["Resumen"]] <- resumen_data
# Agregar cada comparación a la lista de hojas (REFORMATEADAS)
for (i in seq_along(resultados$comparaciones_lista)) {
comparacion_data <- resultados$comparaciones_lista[[i]]
nombre_hoja <- paste0("Comp_", i)
# Reformatear la tabla para descarga
tabla_descarga <- reformatear_tabla_comparaciones(
comparacion_data$tabla,
datos_reactive(),
comparacion_data$var_grupo
)
# Si la reformatación falló, usar tabla original
if (is.null(tabla_descarga)) {
tabla_descarga <- comparacion_data$tabla
}
lista_hojas[[nombre_hoja]] <- tabla_descarga
}
# Descargar todas las hojas a la vez
write_xlsx(lista_hojas, file)
}, error = function(e) {
showNotification(paste0("Error al descargar comparaciones múltiples: ", e$message),
type = "error", duration = 5)
})
} else if (!is.null(resultados$comparacion) && nrow(resultados$comparacion) > 0) {
# Modo: Solo la comparación actual
tryCatch({
# Reformatear tabla para descarga
tabla_descarga <- reformatear_tabla_comparaciones(
resultados$comparacion,
datos_reactive(),
input$var_grupo
)
# Si reformatación falló, usar tabla original
if (is.null(tabla_descarga)) {
tabla_descarga <- resultados$comparacion
}
# Descargar la tabla reformatada
write_xlsx(tabla_descarga, file)
}, error = function(e) {
showNotification(paste0("Error al descargar comparación: ", e$message),
type = "error", duration = 5)
})
} else {
# No hay datos para descargar
showNotification("No hay resultados de comparaciones para descargar. Ejecuta primero una comparación de grupos.",
type = "error", duration = 5)
}
}
)
}
shinyApp(ui = ui, server = server)
